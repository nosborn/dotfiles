#!/bin/sh

set -o errexit
set -o nounset

export SETTINGS='{
  "auto_update": false,
  "collaboration_panel": {
    "button": false
  },
  "diagnostics": {
    "inline": {
      "enabled": true
    }
  },
  "file_scan_exclusions": [
    "**/.DS_Store",
    "**/.classpath",
    "**/.git",
    "**/.hg",
    "**/.jj",
    "**/.repo",
    "**/.settings",
    "**/.svn",
    "**/.terraform",
    "**/CVS",
    "**/Thumbs.db"
  ],
  "file_types": {
    "GitHub Actions": [
      ".github/workflows/*.yaml",
      ".github/workflows/*.yml"
    ]
	},
  "git": {
    "blame": {
      "show_avatar": false
    }
  },
  "status_bar": {
    "line_endings_button": true
  },
  "telemetry": {
    "diagnostics": false,
    "metrics": false
  },
  "title_bar": {
    "show_branch_icon": true,
    "show_onboarding_banner": false,
    "show_sign_in": false,
    "show_user_picture": false
  },
  "use_smartcase_search": true,
  "vim_mode": true
}'

contents="$(cat)"
if [ -z "${contents:-}" ]; then
  echo "{}" | jq --argjson settings "${SETTINGS}" '. * $settings'
  exit 0
fi

start_line=$(echo "${contents:-}" | grep -n -m 1 '^[[:space:]]*{' | cut -d: -f1)
if [ -z "${start_line:-}" ]; then
  echo "${contents:-}"
  exit 0
fi

head_lines=$((start_line - 1))
comment_block=$(echo "${contents}" | head -n "${head_lines}")
json_block=$(echo "${contents}" | tail -n "+${start_line}")

modified_json=$(echo "${json_block}" | jq --argjson settings "${SETTINGS}" '. * $settings')

if [ -n "${comment_block:-}" ]; then
  echo "${comment_block}"
fi
echo "${modified_json}"

# vim: ft=sh
